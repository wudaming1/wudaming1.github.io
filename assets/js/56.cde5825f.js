(window.webpackJsonp=window.webpackJsonp||[]).push([[56],{341:function(t,a,s){"use strict";s.r(a);var n=s(14),e=Object(n.a)({},(function(){var t=this,a=t._self._c;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h1",{attrs:{id:"ci-cd"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ci-cd"}},[t._v("#")]),t._v(" CI/CD")]),t._v(" "),a("ul",[a("li",[a("p",[t._v("Continuous Integration (CI)：持续集成。提交给应用程序(甚至是开发分支)的每个更改都是自动且持续地构建和测试的。这些测试确保更改通过为应用程序建立的所有测试、指导方针和代码遵从标准。")])]),t._v(" "),a("li",[a("p",[t._v("Continuous Delivery (CD)：持续交付是超越持续集成的一步。每次将代码更改推入代码库时，不仅要构建和测试应用程序，而且还要持续部署应用程序。然而，对于持续交付，您需要手动触发部署。")])]),t._v(" "),a("li",[a("p",[t._v("Continuous Deployment (CD)：持续部署是持续集成之外的另一个步骤，类似于持续交付。不同之处在于，您不必手动部署应用程序，而是将其设置为自动部署。不需要人工干预。")])]),t._v(" "),a("li",[a("p",[t._v("CodeMagic： 一个基于云端的构建、分发平台，主要为移动端项目服务。")])])]),t._v(" "),a("h2",{attrs:{id:"cd-基于codemagic"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#cd-基于codemagic"}},[t._v("#")]),t._v(" CD（基于CodeMagic）")]),t._v(" "),a("p",[t._v("首先需要注册CodeMagic账号，并关联到对应的项目，https://docs.codemagic.io/getting-started/signup。CodeMagic有两种工作流程定义方式：")]),t._v(" "),a("ol",[a("li",[t._v("基于图形界面"),a("code",[t._v("Workflow Editor")]),t._v("，使用起来简单。")]),t._v(" "),a("li",[t._v("基于"),a("code",[t._v(".yaml")]),t._v("文件，需要理解的概念比较多，但是流程控制更灵活，而且可以使用Build Api来触发。")])]),t._v(" "),a("p",[t._v("基于"),a("code",[t._v(".yaml")]),t._v("文件的CodeMagic流程控制需要在项目的根目录创建codemagic.yaml。")]),t._v(" "),a("h3",{attrs:{id:"codemagic-yaml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#codemagic-yaml"}},[t._v("#")]),t._v(" codemagic.yaml")]),t._v(" "),a("p",[t._v("使用codemagic.yaml文件来定义要执行的任务。codemagic.yaml文件必须有一个"),a("code",[t._v("workflows")]),t._v("顶级元素。一个"),a("code",[t._v("workflows")]),t._v("可以包括很多workflow。官方有一个完整的介绍 https://docs.codemagic.io/yaml-basic-configuration/yaml-getting-started/ 。")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("workflows")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("my-workflow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# workflow ID")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" My workflow name       "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# workflow name displayed in Codemagic UI")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("instance_type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mac_mini_m1   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# machine instance type")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max_build_duration")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# build duration in minutes (min 1, max 120)")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("triggering")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scripts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("artifacts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("publishing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n")])])]),a("h4",{attrs:{id:"environment"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#environment"}},[t._v("#")]),t._v(" environment")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("workflows")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("my-workflow")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("                   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# workflow ID")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" My workflow name       "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# workflow name displayed in Codemagic UI")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("instance_type")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mac_mini_m1   "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# machine instance type")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("max_build_duration")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token number"}},[t._v("60")]),t._v("       "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# build duration in minutes (min 1, max 120)")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("environment")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("vars")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Define your public environment variables here")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("PUBLIC_ENV_VAR")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"value here"')]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("groups")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Import UI defined environment variable groups(either in Application/Team variables) here")]),t._v("\n        "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" staging "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Variables group name, should match with group name defined by UI ")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("flutter")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 3.3.7 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Flutter 版本")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("xcode")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" latest "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# xcode 版本")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cocoapods")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" 1.11.3 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# cocoapods 版本")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("cache")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("triggering")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scripts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("artifacts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("publishing")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n")])])]),a("p",[t._v("在使用build api时。environment中vars和groups部分都可以被覆写。参考https://docs.codemagic.io/rest-api/builds/文档\nvars部分是直接定义的变量，groups部分定义变量，而是表示引入一组变量。")]),t._v(" "),a("p",[a("img",{attrs:{src:"codeMagic_envs.png",alt:"codeMagic env"}}),t._v("\n打开项目设置，选择"),a("code",[t._v("Environment variables")]),t._v("tab标签，在这里设置"),a("code",[t._v("Application environment variables")]),t._v(".")]),t._v(" "),a("p",[t._v("点击下方"),a("code",[t._v("team settings")]),t._v("即可进入team公用环境变量设置。")]),t._v(" "),a("p",[a("img",{attrs:{src:"codeMagic_env_team.png",alt:"codeMagic env team"}}),t._v(".")]),t._v(" "),a("h4",{attrs:{id:"scripts"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#scripts"}},[t._v("#")]),t._v(" scripts")]),t._v(" "),a("p",[t._v("scripts定义了具体的build过程，在这里可以执行任意命令.")]),t._v(" "),a("div",{staticClass:"language-yaml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yaml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("scripts")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(' echo "single line script"\n  '),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Flutter test\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" flutter test\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ignore_failure")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean important"}},[t._v("true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("|")]),a("span",{pre:!0,attrs:{class:"token scalar string"}},[t._v(" \n    #!/usr/bin/env python3")]),t._v("\n\n    print('Multiline python script')\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("name")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" Build for iOS\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" flutter build ios\n")])])]),a("p",[t._v("Android和iOS build 配置参考 https://docs.codemagic.io/yaml-quick-start/building-a-flutter-app/ ，在script块中，我们可以像正常写shell脚本一样，定义变量、流程控制等。")]),t._v(" "),a("h3",{attrs:{id:"版本号自增"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#版本号自增"}},[t._v("#")]),t._v(" 版本号自增")]),t._v(" "),a("p",[t._v("CodeMagic提供了Android和iOS的CLI来帮助我们通过命令行来与googlePlay 和Apple Store交互。项目地址： https://github.com/codemagic-ci-cd/cli-tools")]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("googlePlay")]),t._v(" "),a("ol",[a("li",[t._v("下载google play api access credentials，按文档添加到环境变量： https://docs.codemagic.io/knowledge-codemagic/build-versioning/")]),t._v(" "),a("li",[t._v("使用这个命令获取版本号"),a("code",[t._v('google-play get-latest-build-number --package-name "$PACKAGE_NAME" --tracks="$GOOGLE_PLAY_TRACK"')]),t._v("，需要引用"),a("code",[t._v("GCLOUD_SERVICE_ACCOUNT_CREDENTIALS")]),t._v("所在的环境变量组到variables下。这个可以获取到GOOGLE_PLAY_TRACK下面最新包的版本号。")])]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("app-store")]),t._v(" "),a("ol",[a("li",[t._v("在Teams中，将Integrations下面的Developer Portal项配置好，https://docs.codemagic.io/flutter-code-signing/ios-code-signing/#step-1-creating-an-app-store-api-key-for-codemagic。")]),t._v(" "),a("li",[t._v("使用"),a("code",[t._v('app-store-connect get-latest-testflight-build-number "$APP_ID"')]),t._v("获取testflight中最新包的build number。APP_ID是项目在Testflight中的ID。")])]),t._v(" "),a("hr"),t._v(" "),a("p",[t._v("Flutter")]),t._v(" "),a("p",[t._v("在Flutter的build命令中使用 "),a("code",[t._v("--build-number=$BUILD_NUMBER")]),t._v("来覆写yaml文件的的版本号，这样可以灵活配置。")]),t._v(" "),a("h3",{attrs:{id:"使用build-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用build-api"}},[t._v("#")]),t._v(" 使用build api")]),t._v(" "),a("p",[t._v("官方文档： https://docs.codemagic.io/rest-api/builds/")]),t._v(" "),a("div",{staticClass:"language-bash extra-class"},[a("pre",{pre:!0,attrs:{class:"language-bash"}},[a("code",[t._v("  "),a("span",{pre:!0,attrs:{class:"token function"}},[t._v("curl")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-H")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"Content-Type: application/json"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("-H")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"x-auth-token: <API Token>"')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n       "),a("span",{pre:!0,attrs:{class:"token parameter variable"}},[t._v("--data")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'{\n         "appId": "<app_id>",\n         "workflowId": "<workflow_id>",\n         "branch": "<git_branch_name>"\n       }\'')]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("\\")]),t._v("\n       https://api.codemagic.io/builds\n")])])]),a("p",[t._v("我们需要再gitlab CI中使用这个命令来触发CodeMagic的build流程。")]),t._v(" "),a("h2",{attrs:{id:"ci-基于gitlab"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#ci-基于gitlab"}},[t._v("#")]),t._v(" CI（基于GitLab）")]),t._v(" "),a("p",[t._v("官方文档： https://docs.gitlab.com/ee/ci/")]),t._v(" "),a("p",[t._v("GitLab默认为我们提供好了Runner。")]),t._v(" "),a("h3",{attrs:{id:"gitlab-ci-yml"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#gitlab-ci-yml"}},[t._v("#")]),t._v(" .gitlab-ci.yml")]),t._v(" "),a("p",[t._v(".gitlab-ci.yml需要放在根目录，这个文件描述了所有可执行的jobs，和jobs执行的流程控制，每次远程仓库的修改都会触发该文件的执行。")]),t._v(" "),a("h4",{attrs:{id:"job"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#job"}},[t._v("#")]),t._v(" Job")]),t._v(" "),a("p",[t._v("在.gitlab-ci.yml文件中，Job是顶级元素，结构如下：\n官方文档：https://docs.gitlab.com/ee/ci/yaml/index.html")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ///预定义stage\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" test\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("flutter_test")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Name of the job")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ///用于判断任务是否可以被执行\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$CI_COMMIT_TAG =~ /^.+$/'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" test ///相同stage的job可以并行执行，默认值是test。\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cirrusci/flutter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("3.3.7\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" flutter doctor\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" flutter clean\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" flutter pub get\n\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ///执行脚本\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" flutter test "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Run Flutter test")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" ///指定运行的Runner\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" mobile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Tags for runner")]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("include")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" /// 导入其他文件\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("local")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/gitlab-ci-env/.build-dev.yml'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$CI_COMMIT_TAG =~ /^staging-v.*$/'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("local")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/gitlab-ci-env/.build-uat.yml'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$CI_COMMIT_TAG =~ /^uat-v.*$/'")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("local")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'/gitlab-ci-env/.build-prod.yml'")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("rules")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n      "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("if")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'$CI_COMMIT_TAG =~ /^production-v.*$/'")]),t._v("\n\n")])])]),a("h3",{attrs:{id:"在job中使用codemagic-build-api"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#在job中使用codemagic-build-api"}},[t._v("#")]),t._v(" 在Job中使用CodeMagic Build Api")]),t._v(" "),a("div",{staticClass:"language-yml extra-class"},[a("pre",{pre:!0,attrs:{class:"language-yml"}},[a("code",[a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stages")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" build\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("variables")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("AUTH_TOKEN")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $CM_AUTH_TOKEN "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# variable in the UI")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("APP_ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" $APP_ID_CM "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# variable in the UI")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("FLUTTER_VERSION")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cirrusci/flutter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("3.3.7 "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# selected flutter version")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("RUNNER_TAG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" mobile"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("runner "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# which runner will run the jobs")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ADDITIONAL_ARG")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("no"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("sound"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("null"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("safety\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("XCODE_SCHEME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" qa\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ANDROID_SCHEME")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" qa\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("BUNDLE_ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" com.carsome.demo\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("ENTRY_POINT")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" lib/main_dev.dart\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("WORKFLOW_ID")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build_app\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("IMAGE")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" cirrusci/flutter"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("3.3.7\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("CURL_COMMAND_BODY")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('"\'{\\"appId\\": \\"$APP_ID\\", \\"workflowId\\": \\"$WORKFLOW_ID\\", \\"tag\\": \\"$CI_COMMIT_TAG\\", \\"environment\\": {\\"variables\\":{\\"XCODE_SCHEME\\": \\"$XCODE_SCHEME\\", \\"ANDROID_SCHEME\\": \\"$ANDROID_SCHEME\\", \\"BUNDLE_ID\\": \\"$BUNDLE_ID\\", \\"ENTRY_POINT\\": \\"$ENTRY_POINT\\", \\"ADDITIONAL_ARG\\": \\"$ADDITIONAL_ARG\\"}}}\'"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("CURL_COMMAND")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v('\'curl -H "Content-Type: application/json" -H "x-auth-token: $AUTH_TOKEN" --data $CURL_COMMAND_BODY https://api.codemagic.io/builds\'')]),t._v("\n\n"),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("build_app")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("stage")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" build\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("image")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" docker"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("stable\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("before_script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" apk add "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("update curl "),a("span",{pre:!0,attrs:{class:"token important"}},[t._v("&&")]),t._v(" rm "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v("rf /var/cache/apk/*\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("tags")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" $RUNNER_TAG "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# Tags for runner")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token key atrule"}},[t._v("script")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v("\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $AUTH_TOKEN\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $APP_ID\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" echo $CURL_COMMAND\n    "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("-")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'eval \"$CURL_COMMAND\"'")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token comment"}},[t._v("# 执行命令")]),t._v("\n")])])]),a("p",[t._v("命令参数解释")]),t._v(" "),a("ol",[a("li",[t._v("CodeMagic账号token：进入https://codemagic.io/teams页面，选择账号\n，进入General settings，其中Codemagic API就是我们需要的token。")]),t._v(" "),a("li",[t._v("APP_ID：进入项目设置，在地址栏可以获取到，https://codemagic.io/app/63242b4569cc305120480310/settings ，中间的63242b4569cc305120480310就是。")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Name")]),t._v(" "),a("th",[t._v("Type")]),t._v(" "),a("th",[t._v("Description")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("AUTH_TOKEN")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("CodeMagic账号token")])]),t._v(" "),a("tr",[a("td",[t._v("APP_ID")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("CodeMagic中项目唯一id")])]),t._v(" "),a("tr",[a("td",[t._v("WORKFLOW_ID")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("匹配codemagic.yaml定义的workflow id.")])]),t._v(" "),a("tr",[a("td",[t._v("CI_COMMIT_TAG")]),t._v(" "),a("td",[t._v("string")]),t._v(" "),a("td",[t._v("git tag的hash值，用于pull代码")])]),t._v(" "),a("tr",[a("td",[t._v("environment")]),t._v(" "),a("td",[t._v("map")]),t._v(" "),a("td",[t._v("覆写codemagic.yaml定义的值")])])])]),t._v(" "),a("p",[t._v("由于AUTH_TOKEN和APP_ID是引用的UI变量，所以需要再Gitlab设置对应的CM_AUTH_TOKEN和APP_ID_CM变量。如何定义以及使用UI变量：https://docs.gitlab.com/ee/ci/variables/index.html#define-a-cicd-variable-in-the-ui")])])}),[],!1,null,null,null);a.default=e.exports}}]);