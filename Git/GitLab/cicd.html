<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>CI/CD | 笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.74434097.css" as="style"><link rel="preload" href="/assets/js/app.216bec1f.js" as="script"><link rel="preload" href="/assets/js/2.1e993694.js" as="script"><link rel="preload" href="/assets/js/1.e2ea3b26.js" as="script"><link rel="preload" href="/assets/js/56.cde5825f.js" as="script"><link rel="prefetch" href="/assets/js/10.d5cd1a3b.js"><link rel="prefetch" href="/assets/js/100.26f59802.js"><link rel="prefetch" href="/assets/js/101.a324009d.js"><link rel="prefetch" href="/assets/js/102.4d35dc40.js"><link rel="prefetch" href="/assets/js/103.43eabbce.js"><link rel="prefetch" href="/assets/js/104.98705b9d.js"><link rel="prefetch" href="/assets/js/11.c389195a.js"><link rel="prefetch" href="/assets/js/12.d8e96b1c.js"><link rel="prefetch" href="/assets/js/13.da1e32c4.js"><link rel="prefetch" href="/assets/js/14.325d9a90.js"><link rel="prefetch" href="/assets/js/15.5542c093.js"><link rel="prefetch" href="/assets/js/16.667c4e84.js"><link rel="prefetch" href="/assets/js/17.bd8d538c.js"><link rel="prefetch" href="/assets/js/18.6d3b94c1.js"><link rel="prefetch" href="/assets/js/19.71fc6202.js"><link rel="prefetch" href="/assets/js/20.dd2299aa.js"><link rel="prefetch" href="/assets/js/21.54d7136c.js"><link rel="prefetch" href="/assets/js/22.60da025a.js"><link rel="prefetch" href="/assets/js/23.e6adf6f4.js"><link rel="prefetch" href="/assets/js/24.9663ba71.js"><link rel="prefetch" href="/assets/js/25.0145f894.js"><link rel="prefetch" href="/assets/js/26.b9951f31.js"><link rel="prefetch" href="/assets/js/27.c36dbdac.js"><link rel="prefetch" href="/assets/js/28.44f29683.js"><link rel="prefetch" href="/assets/js/29.e9da48d6.js"><link rel="prefetch" href="/assets/js/3.a824ab41.js"><link rel="prefetch" href="/assets/js/30.16740628.js"><link rel="prefetch" href="/assets/js/31.5570b147.js"><link rel="prefetch" href="/assets/js/32.1ee83478.js"><link rel="prefetch" href="/assets/js/33.5bc4da0f.js"><link rel="prefetch" href="/assets/js/34.82440dbc.js"><link rel="prefetch" href="/assets/js/35.253f9085.js"><link rel="prefetch" href="/assets/js/36.a85499bb.js"><link rel="prefetch" href="/assets/js/37.d371149d.js"><link rel="prefetch" href="/assets/js/38.1db5712e.js"><link rel="prefetch" href="/assets/js/39.495cf2fe.js"><link rel="prefetch" href="/assets/js/4.21631b9f.js"><link rel="prefetch" href="/assets/js/40.79dc2b0b.js"><link rel="prefetch" href="/assets/js/41.504150b8.js"><link rel="prefetch" href="/assets/js/42.677ec064.js"><link rel="prefetch" href="/assets/js/43.3140ffa9.js"><link rel="prefetch" href="/assets/js/44.c448199b.js"><link rel="prefetch" href="/assets/js/45.ffd2b8e7.js"><link rel="prefetch" href="/assets/js/46.dd1e64a9.js"><link rel="prefetch" href="/assets/js/47.50089f82.js"><link rel="prefetch" href="/assets/js/48.ac30e75d.js"><link rel="prefetch" href="/assets/js/49.b4e1c706.js"><link rel="prefetch" href="/assets/js/5.3541f52b.js"><link rel="prefetch" href="/assets/js/50.d7b1706c.js"><link rel="prefetch" href="/assets/js/51.0f268b88.js"><link rel="prefetch" href="/assets/js/52.5dc6da17.js"><link rel="prefetch" href="/assets/js/53.2591d25b.js"><link rel="prefetch" href="/assets/js/54.def92cbd.js"><link rel="prefetch" href="/assets/js/55.543ff3f3.js"><link rel="prefetch" href="/assets/js/57.7d27166c.js"><link rel="prefetch" href="/assets/js/58.5013afec.js"><link rel="prefetch" href="/assets/js/59.3e72e950.js"><link rel="prefetch" href="/assets/js/6.6ed82868.js"><link rel="prefetch" href="/assets/js/60.122a993d.js"><link rel="prefetch" href="/assets/js/61.7b0f629a.js"><link rel="prefetch" href="/assets/js/62.3f894bae.js"><link rel="prefetch" href="/assets/js/63.e8d09bf4.js"><link rel="prefetch" href="/assets/js/64.bcd70498.js"><link rel="prefetch" href="/assets/js/65.501cca3a.js"><link rel="prefetch" href="/assets/js/66.0ca59ac6.js"><link rel="prefetch" href="/assets/js/67.1a7b9c7d.js"><link rel="prefetch" href="/assets/js/68.a666b424.js"><link rel="prefetch" href="/assets/js/69.2fc5c8db.js"><link rel="prefetch" href="/assets/js/7.4dbea005.js"><link rel="prefetch" href="/assets/js/70.9475d2b2.js"><link rel="prefetch" href="/assets/js/71.c6b46e84.js"><link rel="prefetch" href="/assets/js/72.02b74fca.js"><link rel="prefetch" href="/assets/js/73.4fae572d.js"><link rel="prefetch" href="/assets/js/74.8f00411d.js"><link rel="prefetch" href="/assets/js/75.e50d3a86.js"><link rel="prefetch" href="/assets/js/76.dc989c1c.js"><link rel="prefetch" href="/assets/js/77.4322bd0a.js"><link rel="prefetch" href="/assets/js/78.841ddaed.js"><link rel="prefetch" href="/assets/js/79.c6be5bb4.js"><link rel="prefetch" href="/assets/js/80.5a54b4fb.js"><link rel="prefetch" href="/assets/js/81.6534611d.js"><link rel="prefetch" href="/assets/js/82.b827c774.js"><link rel="prefetch" href="/assets/js/83.013b6aef.js"><link rel="prefetch" href="/assets/js/84.def83e64.js"><link rel="prefetch" href="/assets/js/85.9f1630cc.js"><link rel="prefetch" href="/assets/js/86.a794c1df.js"><link rel="prefetch" href="/assets/js/87.61619766.js"><link rel="prefetch" href="/assets/js/88.ab39111a.js"><link rel="prefetch" href="/assets/js/89.268869da.js"><link rel="prefetch" href="/assets/js/90.c2956654.js"><link rel="prefetch" href="/assets/js/91.92fc0ad5.js"><link rel="prefetch" href="/assets/js/92.a3214003.js"><link rel="prefetch" href="/assets/js/93.296e0484.js"><link rel="prefetch" href="/assets/js/94.c7c51717.js"><link rel="prefetch" href="/assets/js/95.99b7f150.js"><link rel="prefetch" href="/assets/js/96.80f58e89.js"><link rel="prefetch" href="/assets/js/97.354b2dfb.js"><link rel="prefetch" href="/assets/js/98.ae4fdaa7.js"><link rel="prefetch" href="/assets/js/99.bb4463f1.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.5cff1987.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74434097.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>机器学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dart</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Flutter/" class="sidebar-heading clickable"><span>Flutter</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Java/" class="sidebar-heading clickable"><span>Java</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Android/" class="sidebar-heading clickable"><span>Android</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Git/" class="sidebar-heading clickable router-link-active open"><span>Git</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Git/GitHub/create.html" class="sidebar-link">新增库</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>GitLab</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Git/GitLab/cicd.html" aria-current="page" class="active sidebar-link">CI/CD</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Git/GitLab/cicd.html#cd-基于codemagic" class="sidebar-link">CD（基于CodeMagic）</a></li><li class="sidebar-sub-header"><a href="/Git/GitLab/cicd.html#ci-基于gitlab" class="sidebar-link">CI（基于GitLab）</a></li></ul></li></ul></section></li><li><a href="/Git/base.html" class="sidebar-link">Git常用命令</a></li><li><a href="/Git/core.html" class="sidebar-link">核心概念</a></li><li><a href="/Git/commit.html" class="sidebar-link">提交</a></li><li><a href="/Git/stash.html" class="sidebar-link">储藏</a></li><li><a href="/Git/others.html" class="sidebar-link">其他小功能</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mac</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="ci-cd"><a href="#ci-cd" class="header-anchor">#</a> CI/CD</h1> <ul><li><p>Continuous Integration (CI)：持续集成。提交给应用程序(甚至是开发分支)的每个更改都是自动且持续地构建和测试的。这些测试确保更改通过为应用程序建立的所有测试、指导方针和代码遵从标准。</p></li> <li><p>Continuous Delivery (CD)：持续交付是超越持续集成的一步。每次将代码更改推入代码库时，不仅要构建和测试应用程序，而且还要持续部署应用程序。然而，对于持续交付，您需要手动触发部署。</p></li> <li><p>Continuous Deployment (CD)：持续部署是持续集成之外的另一个步骤，类似于持续交付。不同之处在于，您不必手动部署应用程序，而是将其设置为自动部署。不需要人工干预。</p></li> <li><p>CodeMagic： 一个基于云端的构建、分发平台，主要为移动端项目服务。</p></li></ul> <h2 id="cd-基于codemagic"><a href="#cd-基于codemagic" class="header-anchor">#</a> CD（基于CodeMagic）</h2> <p>首先需要注册CodeMagic账号，并关联到对应的项目，https://docs.codemagic.io/getting-started/signup。CodeMagic有两种工作流程定义方式：</p> <ol><li>基于图形界面<code>Workflow Editor</code>，使用起来简单。</li> <li>基于<code>.yaml</code>文件，需要理解的概念比较多，但是流程控制更灵活，而且可以使用Build Api来触发。</li></ol> <p>基于<code>.yaml</code>文件的CodeMagic流程控制需要在项目的根目录创建codemagic.yaml。</p> <h3 id="codemagic-yaml"><a href="#codemagic-yaml" class="header-anchor">#</a> codemagic.yaml</h3> <p>使用codemagic.yaml文件来定义要执行的任务。codemagic.yaml文件必须有一个<code>workflows</code>顶级元素。一个<code>workflows</code>可以包括很多workflow。官方有一个完整的介绍 https://docs.codemagic.io/yaml-basic-configuration/yaml-getting-started/ 。</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">workflows</span><span class="token punctuation">:</span>
  <span class="token key atrule">my-workflow</span><span class="token punctuation">:</span>                   <span class="token comment"># workflow ID</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> My workflow name       <span class="token comment"># workflow name displayed in Codemagic UI</span>
    <span class="token key atrule">instance_type</span><span class="token punctuation">:</span> mac_mini_m1   <span class="token comment"># machine instance type</span>
    <span class="token key atrule">max_build_duration</span><span class="token punctuation">:</span> <span class="token number">60</span>       <span class="token comment"># build duration in minutes (min 1, max 120)</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">triggering</span><span class="token punctuation">:</span>
    <span class="token key atrule">scripts</span><span class="token punctuation">:</span>
    <span class="token key atrule">artifacts</span><span class="token punctuation">:</span> 
    <span class="token key atrule">publishing</span><span class="token punctuation">:</span> 
</code></pre></div><h4 id="environment"><a href="#environment" class="header-anchor">#</a> environment</h4> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">workflows</span><span class="token punctuation">:</span>
  <span class="token key atrule">my-workflow</span><span class="token punctuation">:</span>                   <span class="token comment"># workflow ID</span>
    <span class="token key atrule">name</span><span class="token punctuation">:</span> My workflow name       <span class="token comment"># workflow name displayed in Codemagic UI</span>
    <span class="token key atrule">instance_type</span><span class="token punctuation">:</span> mac_mini_m1   <span class="token comment"># machine instance type</span>
    <span class="token key atrule">max_build_duration</span><span class="token punctuation">:</span> <span class="token number">60</span>       <span class="token comment"># build duration in minutes (min 1, max 120)</span>
    <span class="token key atrule">environment</span><span class="token punctuation">:</span>
      <span class="token key atrule">vars</span><span class="token punctuation">:</span> <span class="token comment"># Define your public environment variables here</span>
        <span class="token key atrule">PUBLIC_ENV_VAR</span><span class="token punctuation">:</span> <span class="token string">&quot;value here&quot;</span>
      <span class="token key atrule">groups</span><span class="token punctuation">:</span> <span class="token comment"># Import UI defined environment variable groups(either in Application/Team variables) here</span>
        <span class="token punctuation">-</span> staging <span class="token comment"># Variables group name, should match with group name defined by UI </span>
      <span class="token key atrule">flutter</span><span class="token punctuation">:</span> 3.3.7 <span class="token comment"># Flutter 版本</span>
      <span class="token key atrule">xcode</span><span class="token punctuation">:</span> latest <span class="token comment"># xcode 版本</span>
      <span class="token key atrule">cocoapods</span><span class="token punctuation">:</span> 1.11.3 <span class="token comment"># cocoapods 版本</span>
    <span class="token key atrule">cache</span><span class="token punctuation">:</span>
    <span class="token key atrule">triggering</span><span class="token punctuation">:</span>
    <span class="token key atrule">scripts</span><span class="token punctuation">:</span>
    <span class="token key atrule">artifacts</span><span class="token punctuation">:</span> 
    <span class="token key atrule">publishing</span><span class="token punctuation">:</span> 
</code></pre></div><p>在使用build api时。environment中vars和groups部分都可以被覆写。参考https://docs.codemagic.io/rest-api/builds/文档
vars部分是直接定义的变量，groups部分定义变量，而是表示引入一组变量。</p> <p><img src="codeMagic_envs.png" alt="codeMagic env">
打开项目设置，选择<code>Environment variables</code>tab标签，在这里设置<code>Application environment variables</code>.</p> <p>点击下方<code>team settings</code>即可进入team公用环境变量设置。</p> <p><img src="codeMagic_env_team.png" alt="codeMagic env team">.</p> <h4 id="scripts"><a href="#scripts" class="header-anchor">#</a> scripts</h4> <p>scripts定义了具体的build过程，在这里可以执行任意命令.</p> <div class="language-yaml extra-class"><pre class="language-yaml"><code><span class="token key atrule">scripts</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> echo &quot;single line script&quot;
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Flutter test
    <span class="token key atrule">script</span><span class="token punctuation">:</span> flutter test
    <span class="token key atrule">ignore_failure</span><span class="token punctuation">:</span> <span class="token boolean important">true</span>
  <span class="token punctuation">-</span> <span class="token punctuation">|</span><span class="token scalar string"> 
    #!/usr/bin/env python3</span>

    print('Multiline python script')
  <span class="token punctuation">-</span> <span class="token key atrule">name</span><span class="token punctuation">:</span> Build for iOS
    <span class="token key atrule">script</span><span class="token punctuation">:</span> flutter build ios
</code></pre></div><p>Android和iOS build 配置参考 https://docs.codemagic.io/yaml-quick-start/building-a-flutter-app/ ，在script块中，我们可以像正常写shell脚本一样，定义变量、流程控制等。</p> <h3 id="版本号自增"><a href="#版本号自增" class="header-anchor">#</a> 版本号自增</h3> <p>CodeMagic提供了Android和iOS的CLI来帮助我们通过命令行来与googlePlay 和Apple Store交互。项目地址： https://github.com/codemagic-ci-cd/cli-tools</p> <hr> <p>googlePlay</p> <ol><li>下载google play api access credentials，按文档添加到环境变量： https://docs.codemagic.io/knowledge-codemagic/build-versioning/</li> <li>使用这个命令获取版本号<code>google-play get-latest-build-number --package-name &quot;$PACKAGE_NAME&quot; --tracks=&quot;$GOOGLE_PLAY_TRACK&quot;</code>，需要引用<code>GCLOUD_SERVICE_ACCOUNT_CREDENTIALS</code>所在的环境变量组到variables下。这个可以获取到GOOGLE_PLAY_TRACK下面最新包的版本号。</li></ol> <hr> <p>app-store</p> <ol><li>在Teams中，将Integrations下面的Developer Portal项配置好，https://docs.codemagic.io/flutter-code-signing/ios-code-signing/#step-1-creating-an-app-store-api-key-for-codemagic。</li> <li>使用<code>app-store-connect get-latest-testflight-build-number &quot;$APP_ID&quot;</code>获取testflight中最新包的build number。APP_ID是项目在Testflight中的ID。</li></ol> <hr> <p>Flutter</p> <p>在Flutter的build命令中使用 <code>--build-number=$BUILD_NUMBER</code>来覆写yaml文件的的版本号，这样可以灵活配置。</p> <h3 id="使用build-api"><a href="#使用build-api" class="header-anchor">#</a> 使用build api</h3> <p>官方文档： https://docs.codemagic.io/rest-api/builds/</p> <div class="language-bash extra-class"><pre class="language-bash"><code>  <span class="token function">curl</span> <span class="token parameter variable">-H</span> <span class="token string">&quot;Content-Type: application/json&quot;</span> <span class="token punctuation">\</span>
       <span class="token parameter variable">-H</span> <span class="token string">&quot;x-auth-token: &lt;API Token&gt;&quot;</span> <span class="token punctuation">\</span>
       <span class="token parameter variable">--data</span> <span class="token string">'{
         &quot;appId&quot;: &quot;&lt;app_id&gt;&quot;,
         &quot;workflowId&quot;: &quot;&lt;workflow_id&gt;&quot;,
         &quot;branch&quot;: &quot;&lt;git_branch_name&gt;&quot;
       }'</span> <span class="token punctuation">\</span>
       https://api.codemagic.io/builds
</code></pre></div><p>我们需要再gitlab CI中使用这个命令来触发CodeMagic的build流程。</p> <h2 id="ci-基于gitlab"><a href="#ci-基于gitlab" class="header-anchor">#</a> CI（基于GitLab）</h2> <p>官方文档： https://docs.gitlab.com/ee/ci/</p> <p>GitLab默认为我们提供好了Runner。</p> <h3 id="gitlab-ci-yml"><a href="#gitlab-ci-yml" class="header-anchor">#</a> .gitlab-ci.yml</h3> <p>.gitlab-ci.yml需要放在根目录，这个文件描述了所有可执行的jobs，和jobs执行的流程控制，每次远程仓库的修改都会触发该文件的执行。</p> <h4 id="job"><a href="#job" class="header-anchor">#</a> Job</h4> <p>在.gitlab-ci.yml文件中，Job是顶级元素，结构如下：
官方文档：https://docs.gitlab.com/ee/ci/yaml/index.html</p> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">stages</span><span class="token punctuation">:</span> ///预定义stage
  <span class="token punctuation">-</span> test
  <span class="token punctuation">-</span> build

<span class="token key atrule">flutter_test</span><span class="token punctuation">:</span> <span class="token comment"># Name of the job</span>
  <span class="token key atrule">rules</span><span class="token punctuation">:</span> ///用于判断任务是否可以被执行
    <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">'$CI_COMMIT_TAG =~ /^.+$/'</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> test ///相同stage的job可以并行执行，默认值是test。
  <span class="token key atrule">image</span><span class="token punctuation">:</span> cirrusci/flutter<span class="token punctuation">:</span>3.3.7
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span> 
    <span class="token punctuation">-</span> flutter doctor
    <span class="token punctuation">-</span> flutter clean
    <span class="token punctuation">-</span> flutter pub get

  <span class="token key atrule">script</span><span class="token punctuation">:</span> ///执行脚本
    <span class="token punctuation">-</span> flutter test <span class="token comment"># Run Flutter test</span>
  <span class="token key atrule">tags</span><span class="token punctuation">:</span> ///指定运行的Runner
    <span class="token punctuation">-</span> mobile<span class="token punctuation">-</span>runner <span class="token comment"># Tags for runner</span>

<span class="token key atrule">include</span><span class="token punctuation">:</span> /// 导入其他文件
  <span class="token punctuation">-</span> <span class="token key atrule">local</span><span class="token punctuation">:</span> <span class="token string">'/gitlab-ci-env/.build-dev.yml'</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">'$CI_COMMIT_TAG =~ /^staging-v.*$/'</span>
  <span class="token punctuation">-</span> <span class="token key atrule">local</span><span class="token punctuation">:</span> <span class="token string">'/gitlab-ci-env/.build-uat.yml'</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">'$CI_COMMIT_TAG =~ /^uat-v.*$/'</span>
  <span class="token punctuation">-</span> <span class="token key atrule">local</span><span class="token punctuation">:</span> <span class="token string">'/gitlab-ci-env/.build-prod.yml'</span>
    <span class="token key atrule">rules</span><span class="token punctuation">:</span>
      <span class="token punctuation">-</span> <span class="token key atrule">if</span><span class="token punctuation">:</span> <span class="token string">'$CI_COMMIT_TAG =~ /^production-v.*$/'</span>

</code></pre></div><h3 id="在job中使用codemagic-build-api"><a href="#在job中使用codemagic-build-api" class="header-anchor">#</a> 在Job中使用CodeMagic Build Api</h3> <div class="language-yml extra-class"><pre class="language-yml"><code><span class="token key atrule">stages</span><span class="token punctuation">:</span>
  <span class="token punctuation">-</span> build

<span class="token key atrule">variables</span><span class="token punctuation">:</span> 
  <span class="token key atrule">AUTH_TOKEN</span><span class="token punctuation">:</span> $CM_AUTH_TOKEN <span class="token comment"># variable in the UI</span>
  <span class="token key atrule">APP_ID</span><span class="token punctuation">:</span> $APP_ID_CM <span class="token comment"># variable in the UI</span>
  <span class="token key atrule">FLUTTER_VERSION</span><span class="token punctuation">:</span> cirrusci/flutter<span class="token punctuation">:</span>3.3.7 <span class="token comment"># selected flutter version</span>
  <span class="token key atrule">RUNNER_TAG</span><span class="token punctuation">:</span> mobile<span class="token punctuation">-</span>runner <span class="token comment"># which runner will run the jobs</span>
  <span class="token key atrule">ADDITIONAL_ARG</span><span class="token punctuation">:</span> <span class="token punctuation">-</span><span class="token punctuation">-</span>no<span class="token punctuation">-</span>sound<span class="token punctuation">-</span>null<span class="token punctuation">-</span>safety
  <span class="token key atrule">XCODE_SCHEME</span><span class="token punctuation">:</span> qa
  <span class="token key atrule">ANDROID_SCHEME</span><span class="token punctuation">:</span> qa
  <span class="token key atrule">BUNDLE_ID</span><span class="token punctuation">:</span> com.carsome.demo
  <span class="token key atrule">ENTRY_POINT</span><span class="token punctuation">:</span> lib/main_dev.dart
  <span class="token key atrule">WORKFLOW_ID</span><span class="token punctuation">:</span> build_app
  <span class="token key atrule">IMAGE</span><span class="token punctuation">:</span> cirrusci/flutter<span class="token punctuation">:</span>3.3.7
  <span class="token key atrule">CURL_COMMAND_BODY</span><span class="token punctuation">:</span> <span class="token string">&quot;'{\&quot;appId\&quot;: \&quot;$APP_ID\&quot;, \&quot;workflowId\&quot;: \&quot;$WORKFLOW_ID\&quot;, \&quot;tag\&quot;: \&quot;$CI_COMMIT_TAG\&quot;, \&quot;environment\&quot;: {\&quot;variables\&quot;:{\&quot;XCODE_SCHEME\&quot;: \&quot;$XCODE_SCHEME\&quot;, \&quot;ANDROID_SCHEME\&quot;: \&quot;$ANDROID_SCHEME\&quot;, \&quot;BUNDLE_ID\&quot;: \&quot;$BUNDLE_ID\&quot;, \&quot;ENTRY_POINT\&quot;: \&quot;$ENTRY_POINT\&quot;, \&quot;ADDITIONAL_ARG\&quot;: \&quot;$ADDITIONAL_ARG\&quot;}}}'&quot;</span>
  <span class="token key atrule">CURL_COMMAND</span><span class="token punctuation">:</span> <span class="token string">'curl -H &quot;Content-Type: application/json&quot; -H &quot;x-auth-token: $AUTH_TOKEN&quot; --data $CURL_COMMAND_BODY https://api.codemagic.io/builds'</span>

<span class="token key atrule">build_app</span><span class="token punctuation">:</span>
  <span class="token key atrule">stage</span><span class="token punctuation">:</span> build
  <span class="token key atrule">image</span><span class="token punctuation">:</span> docker<span class="token punctuation">:</span>stable
  <span class="token key atrule">before_script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> apk add <span class="token punctuation">-</span><span class="token punctuation">-</span>update curl <span class="token important">&amp;&amp;</span> rm <span class="token punctuation">-</span>rf /var/cache/apk/*
  <span class="token key atrule">tags</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> $RUNNER_TAG <span class="token comment"># Tags for runner</span>
  <span class="token key atrule">script</span><span class="token punctuation">:</span>
    <span class="token punctuation">-</span> echo $AUTH_TOKEN
    <span class="token punctuation">-</span> echo $APP_ID
    <span class="token punctuation">-</span> echo $CURL_COMMAND
    <span class="token punctuation">-</span> <span class="token string">'eval &quot;$CURL_COMMAND&quot;'</span> <span class="token comment"># 执行命令</span>
</code></pre></div><p>命令参数解释</p> <ol><li>CodeMagic账号token：进入https://codemagic.io/teams页面，选择账号
，进入General settings，其中Codemagic API就是我们需要的token。</li> <li>APP_ID：进入项目设置，在地址栏可以获取到，https://codemagic.io/app/63242b4569cc305120480310/settings ，中间的63242b4569cc305120480310就是。</li></ol> <table><thead><tr><th>Name</th> <th>Type</th> <th>Description</th></tr></thead> <tbody><tr><td>AUTH_TOKEN</td> <td>string</td> <td>CodeMagic账号token</td></tr> <tr><td>APP_ID</td> <td>string</td> <td>CodeMagic中项目唯一id</td></tr> <tr><td>WORKFLOW_ID</td> <td>string</td> <td>匹配codemagic.yaml定义的workflow id.</td></tr> <tr><td>CI_COMMIT_TAG</td> <td>string</td> <td>git tag的hash值，用于pull代码</td></tr> <tr><td>environment</td> <td>map</td> <td>覆写codemagic.yaml定义的值</td></tr></tbody></table> <p>由于AUTH_TOKEN和APP_ID是引用的UI变量，所以需要再Gitlab设置对应的CM_AUTH_TOKEN和APP_ID_CM变量。如何定义以及使用UI变量：https://docs.gitlab.com/ee/ci/variables/index.html#define-a-cicd-variable-in-the-ui</p></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Git/GitHub/create.html" class="prev">
        新增库
      </a></span> <span class="next"><a href="/Git/base.html">
        Git常用命令
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.216bec1f.js" defer></script><script src="/assets/js/2.1e993694.js" defer></script><script src="/assets/js/1.e2ea3b26.js" defer></script><script src="/assets/js/56.cde5825f.js" defer></script>
  </body>
</html>
