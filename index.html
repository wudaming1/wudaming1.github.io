<!DOCTYPE html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>reCAPTCHA Enterprise Bridge</title>
    <meta name="robots" content="noindex,nofollow">
    <style>
      html, body {
        height: 100%;
        margin: 0;
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Helvetica, Arial, sans-serif;
        background: #0f172a;
        color: #e2e8f0;
      }
      body {
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 24px;
        box-sizing: border-box;
      }
      .status-panel {
        max-width: 420px;
        width: 100%;
        background: rgba(15, 23, 42, 0.8);
        border: 1px solid rgba(148, 163, 184, 0.4);
        border-radius: 12px;
        padding: 24px;
        box-shadow: 0 20px 45px rgba(8, 15, 40, 0.45);
        backdrop-filter: blur(14px);
        text-align: center;
      }
      .status-panel h1 {
        margin: 0 0 12px;
        font-size: 20px;
        letter-spacing: 0.02em;
      }
      .status-panel p {
        margin: 6px 0;
        line-height: 1.6;
        font-size: 15px;
      }
      .status-panel .hint {
        font-size: 13px;
        color: #94a3b8;
      }
    </style>
  </head>
  <body>
    <div class="status-panel">
      <h1>正在进行身份校验</h1>
      <p id="recaptcha-status">正在等待 reCAPTCHA Enterprise 参数...</p>
      <p class="hint">需要 URL 中提供 sitekey 与 applink 参数。</p>
    </div>
    <script>
      (function() {
        'use strict';

        var statusEl = document.getElementById('recaptcha-status');
        var params = new URLSearchParams(window.location.search);
        var siteKey = params.get('sitekey');
        var appLink = params.get('applink');

        function setStatus(message) {
          if (statusEl) {
            statusEl.textContent = message;
          }
        }

        if (!siteKey) {
          setStatus('缺少 sitekey 参数。');
          return;
        }

        if (!appLink) {
          setStatus('缺少 applink 参数。');
          return;
        }

        setStatus('正在加载 reCAPTCHA Enterprise...');

        function handleError(prefix, error) {
          var detail = error && error.message ? error.message : error;
          setStatus(prefix + (detail ? ' ' + detail : ''));
        }

        var recaptchaScript = document.createElement('script');
        recaptchaScript.src = 'https://www.google.com/recaptcha/enterprise.js?render=' + encodeURIComponent(siteKey);
        recaptchaScript.async = true;
        recaptchaScript.onerror = function() {
          setStatus('无法加载 reCAPTCHA Enterprise 脚本。');
        };
        recaptchaScript.onload = function() {
          if (!window.grecaptcha || !window.grecaptcha.enterprise) {
            setStatus('reCAPTCHA Enterprise 初始化失败。');
            return;
          }

          window.grecaptcha.enterprise.ready(function() {
            setStatus('正在向 reCAPTCHA 请求令牌...');
            window.grecaptcha.enterprise.execute(siteKey, { action: 'applink' }).then(function(token) {
              setStatus('已获取令牌，正在回传...');

              var redirectUrl;
              try {
                redirectUrl = new URL(appLink);
                redirectUrl.searchParams.set('recaptcha_token', token);
                window.location.href = redirectUrl.toString();
                return;
              } catch (parseError) {
                /* Fallback for custom schemes. */
              }

              var separator = appLink.indexOf('?') === -1 ? '?' : '&';
              window.location.href = appLink + separator + 'recaptcha_token=' + encodeURIComponent(token);
            }).catch(function(err) {
              handleError('reCAPTCHA 请求失败。', err);
            });
          });
        };

        document.head.appendChild(recaptchaScript);
      })();
    </script>
  </body>
</html>
