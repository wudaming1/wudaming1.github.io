<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Viewport | 笔记</title>
    <meta name="generator" content="VuePress 1.9.10">
    
    <meta name="description" content="Just playing around">
    
    <link rel="preload" href="/assets/css/0.styles.74434097.css" as="style"><link rel="preload" href="/assets/js/app.5f1f056a.js" as="script"><link rel="preload" href="/assets/js/2.31e0fda6.js" as="script"><link rel="preload" href="/assets/js/1.e6eebce2.js" as="script"><link rel="preload" href="/assets/js/26.494c4d90.js" as="script"><link rel="prefetch" href="/assets/js/10.327426a1.js"><link rel="prefetch" href="/assets/js/100.d834ec78.js"><link rel="prefetch" href="/assets/js/101.e80d5aa3.js"><link rel="prefetch" href="/assets/js/102.49b6d3a4.js"><link rel="prefetch" href="/assets/js/103.d471813c.js"><link rel="prefetch" href="/assets/js/104.0130464f.js"><link rel="prefetch" href="/assets/js/105.dfc298ef.js"><link rel="prefetch" href="/assets/js/106.34cb2c49.js"><link rel="prefetch" href="/assets/js/107.52585675.js"><link rel="prefetch" href="/assets/js/11.c389195a.js"><link rel="prefetch" href="/assets/js/12.ed0874fc.js"><link rel="prefetch" href="/assets/js/13.d4ef72a9.js"><link rel="prefetch" href="/assets/js/14.f396422c.js"><link rel="prefetch" href="/assets/js/15.5542c093.js"><link rel="prefetch" href="/assets/js/16.3c547906.js"><link rel="prefetch" href="/assets/js/17.bd8d538c.js"><link rel="prefetch" href="/assets/js/18.6d3b94c1.js"><link rel="prefetch" href="/assets/js/19.eb35cfee.js"><link rel="prefetch" href="/assets/js/20.c11ec329.js"><link rel="prefetch" href="/assets/js/21.61a7635f.js"><link rel="prefetch" href="/assets/js/22.f0264e33.js"><link rel="prefetch" href="/assets/js/23.030f5250.js"><link rel="prefetch" href="/assets/js/24.222ecc10.js"><link rel="prefetch" href="/assets/js/25.701d909c.js"><link rel="prefetch" href="/assets/js/27.12fd3104.js"><link rel="prefetch" href="/assets/js/28.2be92744.js"><link rel="prefetch" href="/assets/js/29.c6d92e41.js"><link rel="prefetch" href="/assets/js/3.5322f14a.js"><link rel="prefetch" href="/assets/js/30.26e29c5b.js"><link rel="prefetch" href="/assets/js/31.13b7fd7f.js"><link rel="prefetch" href="/assets/js/32.2d241c9b.js"><link rel="prefetch" href="/assets/js/33.0f815c9f.js"><link rel="prefetch" href="/assets/js/34.1e8edce9.js"><link rel="prefetch" href="/assets/js/35.24d783b8.js"><link rel="prefetch" href="/assets/js/36.c8a6878d.js"><link rel="prefetch" href="/assets/js/37.2766f351.js"><link rel="prefetch" href="/assets/js/38.a289ef98.js"><link rel="prefetch" href="/assets/js/39.201c6348.js"><link rel="prefetch" href="/assets/js/4.e361652c.js"><link rel="prefetch" href="/assets/js/40.a8fe3451.js"><link rel="prefetch" href="/assets/js/41.dd4c0c92.js"><link rel="prefetch" href="/assets/js/42.88e21e57.js"><link rel="prefetch" href="/assets/js/43.61396245.js"><link rel="prefetch" href="/assets/js/44.2ad34fbc.js"><link rel="prefetch" href="/assets/js/45.ee77f41f.js"><link rel="prefetch" href="/assets/js/46.be989b63.js"><link rel="prefetch" href="/assets/js/47.f2bbd283.js"><link rel="prefetch" href="/assets/js/48.eb925991.js"><link rel="prefetch" href="/assets/js/49.61d951a8.js"><link rel="prefetch" href="/assets/js/5.db44182a.js"><link rel="prefetch" href="/assets/js/50.be3b4c75.js"><link rel="prefetch" href="/assets/js/51.10537997.js"><link rel="prefetch" href="/assets/js/52.29018134.js"><link rel="prefetch" href="/assets/js/53.829aad1b.js"><link rel="prefetch" href="/assets/js/54.ae937883.js"><link rel="prefetch" href="/assets/js/55.e6107c47.js"><link rel="prefetch" href="/assets/js/56.d30e9bf7.js"><link rel="prefetch" href="/assets/js/57.ffc1fca0.js"><link rel="prefetch" href="/assets/js/58.969d997e.js"><link rel="prefetch" href="/assets/js/59.0b6fb9a8.js"><link rel="prefetch" href="/assets/js/6.8927cfed.js"><link rel="prefetch" href="/assets/js/60.da7b2183.js"><link rel="prefetch" href="/assets/js/61.8bc7ce58.js"><link rel="prefetch" href="/assets/js/62.89384bf0.js"><link rel="prefetch" href="/assets/js/63.19e2965c.js"><link rel="prefetch" href="/assets/js/64.a15cc139.js"><link rel="prefetch" href="/assets/js/65.299d8863.js"><link rel="prefetch" href="/assets/js/66.80d274de.js"><link rel="prefetch" href="/assets/js/67.989385a1.js"><link rel="prefetch" href="/assets/js/68.2eff7f4e.js"><link rel="prefetch" href="/assets/js/69.6543163f.js"><link rel="prefetch" href="/assets/js/7.836131da.js"><link rel="prefetch" href="/assets/js/70.b0f0b548.js"><link rel="prefetch" href="/assets/js/71.71828c12.js"><link rel="prefetch" href="/assets/js/72.4e5ba134.js"><link rel="prefetch" href="/assets/js/73.0bc241c6.js"><link rel="prefetch" href="/assets/js/74.6cd734dd.js"><link rel="prefetch" href="/assets/js/75.c4c809c8.js"><link rel="prefetch" href="/assets/js/76.7e05e2ce.js"><link rel="prefetch" href="/assets/js/77.f422c181.js"><link rel="prefetch" href="/assets/js/78.354e5765.js"><link rel="prefetch" href="/assets/js/79.15b6ed78.js"><link rel="prefetch" href="/assets/js/80.28636fd9.js"><link rel="prefetch" href="/assets/js/81.80f2879b.js"><link rel="prefetch" href="/assets/js/82.402e5ad3.js"><link rel="prefetch" href="/assets/js/83.df4a6ac0.js"><link rel="prefetch" href="/assets/js/84.2f545e47.js"><link rel="prefetch" href="/assets/js/85.33c72fd2.js"><link rel="prefetch" href="/assets/js/86.2f4ad258.js"><link rel="prefetch" href="/assets/js/87.9417cb80.js"><link rel="prefetch" href="/assets/js/88.caa6b446.js"><link rel="prefetch" href="/assets/js/89.6adc3665.js"><link rel="prefetch" href="/assets/js/90.fcec355b.js"><link rel="prefetch" href="/assets/js/91.7fcc7c82.js"><link rel="prefetch" href="/assets/js/92.75091350.js"><link rel="prefetch" href="/assets/js/93.d6106a07.js"><link rel="prefetch" href="/assets/js/94.3b050f91.js"><link rel="prefetch" href="/assets/js/95.8971153b.js"><link rel="prefetch" href="/assets/js/96.a969222c.js"><link rel="prefetch" href="/assets/js/97.da2f8e94.js"><link rel="prefetch" href="/assets/js/98.ac3e0b86.js"><link rel="prefetch" href="/assets/js/99.e1e3c300.js"><link rel="prefetch" href="/assets/js/vendors~docsearch.d098b00c.js">
    <link rel="stylesheet" href="/assets/css/0.styles.74434097.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><!----> <span class="site-name">笔记</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <!----></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><!---->  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>机器学习</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Dart</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Flutter/" class="sidebar-heading clickable router-link-active open"><span>Flutter</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/Flutter/provider.html" class="sidebar-link">Provider</a></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading open"><span>sliver</span> <span class="arrow down"></span></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/Flutter/sliver/layout.html" class="sidebar-link">Sliver 协议</a></li><li><a href="/Flutter/sliver/scrollable.html" class="sidebar-link">Scrollable</a></li><li><a href="/Flutter/sliver/viewport.html" aria-current="page" class="active sidebar-link">Viewport</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/Flutter/sliver/viewport.html#如何测量-sliver" class="sidebar-link">如何测量 Sliver</a></li><li class="sidebar-sub-header"><a href="/Flutter/sliver/viewport.html#renderviewport" class="sidebar-link">RenderViewport</a></li></ul></li><li><a href="/Flutter/sliver/widget.html" class="sidebar-link">SliverWidget</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Flutter/build" class="sidebar-heading clickable"><span>build</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>layout</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><p class="sidebar-heading"><span>核心Widget</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Flutter/navigator" class="sidebar-heading clickable"><span>navigator</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/Flutter/GetX" class="sidebar-heading clickable"><span>GetX</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Java/" class="sidebar-heading clickable"><span>Java</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Android/" class="sidebar-heading clickable"><span>Android</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/Git/" class="sidebar-heading clickable"><span>Git</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Mac</span> <span class="arrow right"></span></p> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><p class="sidebar-heading"><span>Web</span> <span class="arrow right"></span></p> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="viewport"><a href="#viewport" class="header-anchor">#</a> Viewport</h1> <p>Viewport 是 Sliver 布局的起点，也是滚动机制的重要组成部分。作为滚动视窗，他也是用户滚动和 Sliver 展示联动的桥梁。</p> <h2 id="如何测量-sliver"><a href="#如何测量-sliver" class="header-anchor">#</a> 如何测量 Sliver</h2> <p>核心方法是 layoutChildSequence，起点是_attemptLayout。</p> <p>_attemptLayout：</p> <div class="language- extra-class"><pre class="language-text"><code>double _attemptLayout(double mainAxisExtent, double crossAxisExtent, double correctedOffset) {
    assert(!mainAxisExtent.isNaN);
    assert(mainAxisExtent &gt;= 0.0);
    assert(crossAxisExtent.isFinite);
    assert(crossAxisExtent &gt;= 0.0);
    assert(correctedOffset.isFinite);
    _minScrollExtent = 0.0;
    _maxScrollExtent = 0.0;
    _hasVisualOverflow = false;

    // centerOffset is the offset from the leading edge of the RenderViewport
    // to the zero scroll offset (the line between the forward slivers and the
    // reverse slivers).
    final double centerOffset = mainAxisExtent * anchor - correctedOffset;
    final double reverseDirectionRemainingPaintExtent = clampDouble(centerOffset, 0.0, mainAxisExtent);
    final double forwardDirectionRemainingPaintExtent = clampDouble(mainAxisExtent - centerOffset, 0.0, mainAxisExtent);

    switch (cacheExtentStyle) {
      case CacheExtentStyle.pixel:
        _calculatedCacheExtent = cacheExtent;
      case CacheExtentStyle.viewport:
        _calculatedCacheExtent = mainAxisExtent * _cacheExtent;
    }

    final double fullCacheExtent = mainAxisExtent + 2 * _calculatedCacheExtent!;
    final double centerCacheOffset = centerOffset + _calculatedCacheExtent!;
    final double reverseDirectionRemainingCacheExtent = clampDouble(centerCacheOffset, 0.0, fullCacheExtent);
    final double forwardDirectionRemainingCacheExtent = clampDouble(fullCacheExtent - centerCacheOffset, 0.0, fullCacheExtent);

    final RenderSliver? leadingNegativeChild = childBefore(center!);

    if (leadingNegativeChild != null) {
      // negative scroll offsets
      final double result = layoutChildSequence(
        child: leadingNegativeChild,
        scrollOffset: math.max(mainAxisExtent, centerOffset) - mainAxisExtent,
        overlap: 0.0,
        layoutOffset: forwardDirectionRemainingPaintExtent,
        remainingPaintExtent: reverseDirectionRemainingPaintExtent,
        mainAxisExtent: mainAxisExtent,
        crossAxisExtent: crossAxisExtent,
        growthDirection: GrowthDirection.reverse,
        advance: childBefore,
        remainingCacheExtent: reverseDirectionRemainingCacheExtent,
        cacheOrigin: clampDouble(mainAxisExtent - centerOffset, -_calculatedCacheExtent!, 0.0),
      );
      if (result != 0.0) {
        return -result;
      }
    }

    // positive scroll offsets
    return layoutChildSequence(
      child: center,
      scrollOffset: math.max(0.0, -centerOffset),
      overlap: leadingNegativeChild == null ? math.min(0.0, -centerOffset) : 0.0,
      layoutOffset: centerOffset &gt;= mainAxisExtent ? centerOffset: reverseDirectionRemainingPaintExtent,
      remainingPaintExtent: forwardDirectionRemainingPaintExtent,
      mainAxisExtent: mainAxisExtent,
      crossAxisExtent: crossAxisExtent,
      growthDirection: GrowthDirection.forward,
      advance: childAfter,
      remainingCacheExtent: forwardDirectionRemainingCacheExtent,
      cacheOrigin: clampDouble(centerOffset, -_calculatedCacheExtent!, 0.0),
    );
  }
</code></pre></div><p>layoutChildSequence：</p> <div class="language- extra-class"><pre class="language-text"><code>double layoutChildSequence({
    required RenderSliver? child,
    required double scrollOffset,
    required double overlap,
    required double layoutOffset,
    required double remainingPaintExtent,
    required double mainAxisExtent,
    required double crossAxisExtent,
    required GrowthDirection growthDirection,
    required RenderSliver? Function(RenderSliver child) advance,
    required double remainingCacheExtent,
    required double cacheOrigin,
  }) {
    assert(scrollOffset.isFinite);
    assert(scrollOffset &gt;= 0.0);
    final double initialLayoutOffset = layoutOffset;
    final ScrollDirection adjustedUserScrollDirection =
        applyGrowthDirectionToScrollDirection(offset.userScrollDirection, growthDirection);
    double maxPaintOffset = layoutOffset + overlap;
    double precedingScrollExtent = 0.0;

    while (child != null) {
      final double sliverScrollOffset = scrollOffset &lt;= 0.0 ? 0.0 : scrollOffset;
      // If the scrollOffset is too small we adjust the paddedOrigin because it
      // doesn't make sense to ask a sliver for content before its scroll
      // offset.
      final double correctedCacheOrigin = math.max(cacheOrigin, -sliverScrollOffset);
      final double cacheExtentCorrection = cacheOrigin - correctedCacheOrigin;

      assert(sliverScrollOffset &gt;= correctedCacheOrigin.abs());
      assert(correctedCacheOrigin &lt;= 0.0);
      assert(sliverScrollOffset &gt;= 0.0);
      assert(cacheExtentCorrection &lt;= 0.0);

      child.layout(SliverConstraints(
        axisDirection: axisDirection,
        growthDirection: growthDirection,
        userScrollDirection: adjustedUserScrollDirection,
        scrollOffset: sliverScrollOffset,
        precedingScrollExtent: precedingScrollExtent,
        overlap: maxPaintOffset - layoutOffset,
        remainingPaintExtent: math.max(0.0, remainingPaintExtent - layoutOffset + initialLayoutOffset),
        crossAxisExtent: crossAxisExtent,
        crossAxisDirection: crossAxisDirection,
        viewportMainAxisExtent: mainAxisExtent,
        remainingCacheExtent: math.max(0.0, remainingCacheExtent + cacheExtentCorrection),
        cacheOrigin: correctedCacheOrigin,
      ), parentUsesSize: true);

      final SliverGeometry childLayoutGeometry = child.geometry!;
      assert(childLayoutGeometry.debugAssertIsValid());

      // If there is a correction to apply, we'll have to start over.
      if (childLayoutGeometry.scrollOffsetCorrection != null) {
        return childLayoutGeometry.scrollOffsetCorrection!;
      }

      // We use the child's paint origin in our coordinate system as the
      // layoutOffset we store in the child's parent data.
      final double effectiveLayoutOffset = layoutOffset + childLayoutGeometry.paintOrigin;

      // `effectiveLayoutOffset` becomes meaningless once we moved past the trailing edge
      // because `childLayoutGeometry.layoutExtent` is zero. Using the still increasing
      // 'scrollOffset` to roughly position these invisible slivers in the right order.
      // @1
      if (childLayoutGeometry.visible || scrollOffset &gt; 0) {
        updateChildLayoutOffset(child, effectiveLayoutOffset, growthDirection);
      } else {
        updateChildLayoutOffset(child, -scrollOffset + initialLayoutOffset, growthDirection);
      }
      //@3
      maxPaintOffset = math.max(effectiveLayoutOffset + childLayoutGeometry.paintExtent, maxPaintOffset);
      //@2
      scrollOffset -= childLayoutGeometry.scrollExtent;
      //@4
      precedingScrollExtent += childLayoutGeometry.scrollExtent;
      layoutOffset += childLayoutGeometry.layoutExtent;
      if (childLayoutGeometry.cacheExtent != 0.0) {
        remainingCacheExtent -= childLayoutGeometry.cacheExtent - cacheExtentCorrection;
        cacheOrigin = math.min(correctedCacheOrigin + childLayoutGeometry.cacheExtent, 0.0);
      }

      updateOutOfBandData(growthDirection, childLayoutGeometry);

      // move on to the next child
      child = advance(child);
    }

    // we made it without a correction, whee!
    return 0.0;
  }
</code></pre></div><p>使用 child 的 SliverGeometry 更新的属性有：</p> <ol><li>child 的 ParentData 的 paintOffset：在@1 处，根据局部变量 layoutOffset 和自身绘制偏移。</li> <li>layoutOffset：在@2 处，累加<code>layoutExtent</code> 。</li> <li>maxPaintOffset：在@3 处，累加<code>paintExtent</code>。会附加一些逻辑。</li> <li>precedingScrollExtent：在@4 处，累加<code>scrollExtent</code>。</li> <li>overlap：maxPaintOffset - layoutOffset，当 layoutExtent 和 paintExtent 不一致时，不为 0。</li></ol> <p><img src="/assets/img/sliver_constraints.9abda359.png" alt=""></p> <h2 id="renderviewport"><a href="#renderviewport" class="header-anchor">#</a> RenderViewport</h2> <p>ViewPort 渲染对象</p> <div class="language- extra-class"><pre class="language-text"><code>RenderViewport {
    /// layout驱动，携带偏移信息。
    ViewportOffset _offset;

    /// SliverConstraints.axisDirection
    AxisDirection _axisDirection;


    double _cacheExtent;



}
</code></pre></div></div> <footer class="page-edit"><!----> <!----></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/Flutter/sliver/scrollable.html" class="prev">
        Scrollable
      </a></span> <span class="next"><a href="/Flutter/sliver/widget.html">
        SliverWidget
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.5f1f056a.js" defer></script><script src="/assets/js/2.31e0fda6.js" defer></script><script src="/assets/js/1.e6eebce2.js" defer></script><script src="/assets/js/26.494c4d90.js" defer></script>
  </body>
</html>
